<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal | Glitch Tech Services</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%230a0e27'/%3E%3Cpath d='M30 20 L50 50 L30 80 L40 80 L60 50 L40 20 Z' fill='%2300ff41' opacity='0.8'/%3E%3Cpath d='M45 20 L65 50 L45 80 L55 80 L75 50 L55 20 Z' fill='%2300ff41'/%3E%3Ccircle cx='25' cy='25' r='3' fill='%2300ff41'/%3E%3Ccircle cx='75' cy='25' r='3' fill='%2300ff41'/%3E%3Ccircle cx='25' cy='75' r='3' fill='%2300ff41'/%3E%3Ccircle cx='75' cy='75' r='3' fill='%2300ff41'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-green: #00ff41;
            --dark-bg: #0a0e27;
            --darker-bg: #050810;
            --card-bg: rgba(15, 20, 40, 0.9);
            --border-glow: rgba(0, 255, 65, 0.3);
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--dark-bg);
            color: #e0e0e0;
            min-height: 100vh;
            position: relative;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.15;
            background: 
                linear-gradient(90deg, transparent 49%, var(--neon-green) 49%, var(--neon-green) 51%, transparent 51%),
                linear-gradient(0deg, transparent 49%, var(--neon-green) 49%, var(--neon-green) 51%, transparent 51%);
            background-size: 50px 50px;
            animation: gridPulse 4s ease-in-out infinite;
        }

        @keyframes gridPulse {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.2; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            padding: 20px 0;
            border-bottom: 2px solid var(--border-glow);
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            color: var(--neon-green);
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        .back-link {
            color: var(--neon-green);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .back-link:hover {
            text-shadow: 0 0 10px var(--neon-green);
        }

        .auth-container {
            max-width: 450px;
            margin: 80px auto;
            background: var(--card-bg);
            border: 2px solid var(--border-glow);
            border-radius: 10px;
            padding: 40px;
            position: relative;
            z-index: 10;
        }

        .auth-container h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-green);
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-glow);
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 1rem;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .file-upload-area {
            border: 2px dashed var(--border-glow);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(0, 0, 0, 0.2);
        }

        .file-upload-area:hover {
            border-color: var(--neon-green);
            background: rgba(0, 255, 65, 0.05);
        }

        .file-upload-area.drag-over {
            border-color: var(--neon-green);
            background: rgba(0, 255, 65, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .file-preview {
            margin-top: 15px;
            max-width: 100%;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid var(--border-glow);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--neon-green);
            color: var(--dark-bg);
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 65, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toggle-auth {
            text-align: center;
            margin-top: 20px;
            color: #888;
        }

        .toggle-auth a {
            color: var(--neon-green);
            cursor: pointer;
            text-decoration: none;
        }

        .toggle-auth a:hover {
            text-decoration: underline;
        }

        .dashboard {
            display: none;
            padding: 40px 0;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-green);
        }

        .logout-btn {
            padding: 10px 20px;
            background: transparent;
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: var(--neon-green);
            color: var(--dark-bg);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 2px solid var(--border-glow);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
        }

        .stat-card h3 {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            color: var(--neon-green);
            font-weight: 700;
        }

        .section {
            background: var(--card-bg);
            border: 2px solid var(--border-glow);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-green);
            margin-bottom: 20px;
        }

        .book-repair-btn {
            padding: 15px 30px;
            background: var(--neon-green);
            color: var(--dark-bg);
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
            display: inline-block;
            margin-bottom: 30px;
        }

        .book-repair-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 65, 0.5);
        }

        .repair-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-glow);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .repair-item h3 {
            color: var(--neon-green);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .repair-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid var(--border-glow);
            margin: 10px 0;
            cursor: pointer;
        }

        .repair-image:hover {
            border-color: var(--neon-green);
        }

        .repair-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .repair-info-item {
            font-size: 0.9rem;
        }

        .repair-info-item strong {
            color: #888;
        }

        .status-timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            position: relative;
        }

        .status-timeline::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #333;
            z-index: 0;
        }

        .status-step {
            text-align: center;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .status-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #555;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .status-step.active .status-dot {
            background: var(--neon-green);
            border-color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.6);
            color: var(--dark-bg);
        }

        .status-step.completed .status-dot {
            background: var(--neon-green);
            border-color: var(--neon-green);
            color: var(--dark-bg);
        }

        .status-label {
            font-size: 0.8rem;
            color: #888;
        }

        .status-step.active .status-label,
        .status-step.completed .status-label {
            color: var(--neon-green);
        }

        .messages-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-glow);
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
        }

        .message.from-tech {
            background: rgba(0, 255, 65, 0.1);
            border-left: 3px solid var(--neon-green);
        }

        .message.from-customer {
            background: rgba(100, 100, 100, 0.1);
            border-left: 3px solid #666;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #888;
        }

        .message-sender {
            color: var(--neon-green);
            font-weight: 600;
        }

        .message-content {
            color: #e0e0e0;
        }

        .message-form {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-glow);
            border-radius: 5px;
            color: #e0e0e0;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--neon-green);
        }

        .send-btn {
            padding: 12px 24px;
            background: var(--neon-green);
            color: var(--dark-bg);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .send-btn:hover {
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert.error {
            background: rgba(255, 0, 0, 0.1);
            border-color: #ff0000;
            color: #ff6b6b;
        }

        .alert.success {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .alert.info {
            background: rgba(33, 150, 243, 0.1);
            border-color: #2196f3;
            color: #64b5f6;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 40px;
            border: 2px solid var(--border-glow);
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2rem;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--neon-green);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--neon-green);
        }

        .spinner {
            border: 3px solid rgba(0, 255, 65, 0.3);
            border-top: 3px solid var(--neon-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">GLITCH TECH PORTAL</div>
                <a href="index.html" class="back-link">‚Üê Back to Main Site</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Login/Signup Form -->
        <div class="auth-container" id="authContainer">
            <h2 id="authTitle">Customer Login</h2>
            
            <div id="alertContainer"></div>

            <form id="authForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="your@email.com">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <div class="form-group hidden" id="nameGroup">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" placeholder="John Doe">
                </div>

                <div class="form-group hidden" id="phoneGroup">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" placeholder="(305) 555-1234">
                </div>

                <button type="submit" class="btn" id="authButton">Login</button>
            </form>

            <div class="toggle-auth">
                <span id="toggleText">Don't have an account?</span>
                <a id="toggleLink">Sign Up</a>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <h1>Welcome, <span id="customerName">Customer</span>!</h1>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>

            <button class="book-repair-btn" id="bookRepairBtn">üìÖ Book a Repair</button>

            <!-- Stats -->
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>Active Repairs</h3>
                    <div class="stat-value" id="activeRepairs">0</div>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <div class="stat-value" id="completedRepairs">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Spent</h3>
                    <div class="stat-value" id="totalSpent">$0</div>
                </div>
            </div>

            <!-- Current Repairs -->
            <div class="section">
                <h2>Current Repairs</h2>
                <div id="currentRepairs">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading repairs...
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div class="section">
                <h2>Messages</h2>
                <div class="messages-container" id="messagesContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading messages...
                    </div>
                </div>
                <div class="message-form">
                    <input type="text" class="message-input" id="messageInput" placeholder="Type your message...">
                    <button class="send-btn" id="sendMessage">Send</button>
                </div>
            </div>

            <!-- Repair History -->
            <div class="section">
                <h2>Repair History</h2>
                <div id="repairHistory">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading history...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Book Repair Modal -->
    <div class="modal" id="bookRepairModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeBookingModal()">&times;</span>
            <h2 style="font-family: 'Orbitron', sans-serif; color: var(--neon-green); margin-bottom: 20px;">Book a Repair</h2>
            
            <form id="bookingForm">
                <div class="form-group">
                    <label for="deviceType">Device Type *</label>
                    <select id="deviceType" required>
                        <option value="">Select device type...</option>
                        <option value="laptop">Laptop</option>
                        <option value="desktop">Desktop</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="brand">Brand/Model</label>
                    <input type="text" id="brand" placeholder="e.g., Dell Latitude, HP Pavilion">
                </div>

                <div class="form-group">
                    <label for="issue">What's the problem? *</label>
                    <textarea id="issue" required placeholder="Describe what's wrong with your computer..."></textarea>
                </div>

                <div class="form-group">
                    <label for="serviceType">Service Needed *</label>
                    <select id="serviceType" required>
                        <option value="">Select service...</option>
                        <option value="Virus/Malware Removal">Virus/Malware Removal ($50-80)</option>
                        <option value="Hardware Repair">Hardware Repair ($60-150)</option>
                        <option value="Data Recovery">Data Recovery ($75-200)</option>
                        <option value="Performance Tune-Up">Performance Tune-Up ($40-60)</option>
                        <option value="OS Installation">OS Installation ($60-100)</option>
                        <option value="Diagnostic Only">Diagnostic Only ($30)</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="urgency">How urgent is this?</label>
                    <select id="urgency">
                        <option value="normal">Normal (1-3 days)</option>
                        <option value="urgent">Urgent (same day +$30)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Upload Photo of Device (Optional)</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="upload-icon">üì∏</div>
                        <p>Click or drag image here</p>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">Helps us diagnose the issue</p>
                        <input type="file" id="deviceImage" accept="image/*" style="display: none;">
                    </div>
                    <div class="file-preview" id="filePreview"></div>
                </div>

                <button type="submit" class="btn" id="submitBookingBtn">Submit Repair Request</button>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vylmravtmtoykvejzooi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5bG1yYXZ0bXRveWt2ZWp6b29pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTkwMzIsImV4cCI6MjA4NTM5NTAzMn0.K5yIJjhsN6pf3Fvbh9DDrdbubCLdruJKXwbg1eZSA_o';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let isLogin = true;
        let currentUser = null;
        let selectedFile = null;

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const dashboard = document.getElementById('dashboard');
        const authForm = document.getElementById('authForm');
        const authTitle = document.getElementById('authTitle');
        const authButton = document.getElementById('authButton');
        const toggleText = document.getElementById('toggleText');
        const toggleLink = document.getElementById('toggleLink');
        const nameGroup = document.getElementById('nameGroup');
        const phoneGroup = document.getElementById('phoneGroup');
        const alertContainer = document.getElementById('alertContainer');
        const customerName = document.getElementById('customerName');
        const logoutBtn = document.getElementById('logoutBtn');

        // Check if user is already logged in
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('glitchTechUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            }
        });

        // Toggle between login and signup
        toggleLink.addEventListener('click', () => {
            isLogin = !isLogin;
            if (isLogin) {
                authTitle.textContent = 'Customer Login';
                authButton.textContent = 'Login';
                toggleText.textContent = "Don't have an account?";
                toggleLink.textContent = 'Sign Up';
                nameGroup.classList.add('hidden');
                phoneGroup.classList.add('hidden');
            } else {
                authTitle.textContent = 'Create Account';
                authButton.textContent = 'Sign Up';
                toggleText.textContent = 'Already have an account?';
                toggleLink.textContent = 'Login';
                nameGroup.classList.remove('hidden');
                phoneGroup.classList.remove('hidden');
            }
        });

        // Handle auth form
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authButton.disabled = true;
            authButton.textContent = 'Processing...';

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                if (isLogin) {
                    // Login
                    const { data, error } = await supabase
                        .from('customers')
                        .select('*')
                        .eq('email', email)
                        .single();

                    if (error || !data) {
                        showAlert('Invalid email or password.', 'error');
                        authButton.disabled = false;
                        authButton.textContent = 'Login';
                        return;
                    }

                    // Simple password check (in production, use proper hashing)
                    if (data.password !== password) {
                        showAlert('Invalid email or password.', 'error');
                        authButton.disabled = false;
                        authButton.textContent = 'Login';
                        return;
                    }

                    currentUser = data;
                    localStorage.setItem('glitchTechUser', JSON.stringify(data));
                    showDashboard();
                } else {
                    // Signup
                    const name = document.getElementById('name').value;
                    const phone = document.getElementById('phone').value;

                    // Check if email already exists
                    const { data: existing } = await supabase
                        .from('customers')
                        .select('email')
                        .eq('email', email)
                        .single();

                    if (existing) {
                        showAlert('Account already exists with this email.', 'error');
                        authButton.disabled = false;
                        authButton.textContent = 'Sign Up';
                        return;
                    }

                    // Email verification
                    const verificationCode = Math.floor(100000 + Math.random() * 900000);
                    const code = prompt(`A verification code has been sent to ${email}\n\nIn a real system, you'd receive an email. For demo purposes, your code is: ${verificationCode}\n\nPlease enter the code:`);
                    
                    if (!code || code !== verificationCode.toString()) {
                        showAlert('Invalid verification code. Please try again.', 'error');
                        authButton.disabled = false;
                        authButton.textContent = 'Sign Up';
                        return;
                    }

                    // Create account
                    const { data: newUser, error } = await supabase
                        .from('customers')
                        .insert([{
                            email: email,
                            password: password, // In production, hash this!
                            name: name,
                            phone: phone,
                            verified: true
                        }])
                        .select()
                        .single();

                    if (error) {
                        showAlert('Error creating account: ' + error.message, 'error');
                        authButton.disabled = false;
                        authButton.textContent = 'Sign Up';
                        return;
                    }

                    showAlert('Account created and verified! You can now login.', 'success');
                    setTimeout(() => {
                        isLogin = true;
                        toggleLink.click();
                        authButton.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Auth error:', error);
                showAlert('An error occurred. Please try again.', 'error');
                authButton.disabled = false;
                authButton.textContent = isLogin ? 'Login' : 'Sign Up';
            }
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            localStorage.removeItem('glitchTechUser');
            dashboard.style.display = 'none';
            authContainer.style.display = 'block';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        });

        // Show alert
        function showAlert(message, type) {
            alertContainer.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Show dashboard
        async function showDashboard() {
            authContainer.style.display = 'none';
            dashboard.style.display = 'block';
            customerName.textContent = currentUser.name;

            await loadRepairs();
            await loadMessages();
        }

        // Load repairs
        async function loadRepairs() {
            try {
                const { data: repairs, error } = await supabase
                    .from('repairs')
                    .select('*')
                    .eq('customer_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Update stats
                const activeCount = repairs.filter(r => r.status !== 'completed').length;
                const completedCount = repairs.filter(r => r.status === 'completed').length;
                const totalSpent = repairs
                    .filter(r => r.status === 'completed')
                    .reduce((sum, r) => {
                        const cost = parseInt((r.actual_cost || r.estimated_cost || '0').replace(/\D/g, ''));
                        return sum + cost;
                    }, 0);

                document.getElementById('activeRepairs').textContent = activeCount;
                document.getElementById('completedRepairs').textContent = completedCount;
                document.getElementById('totalSpent').textContent = `$${totalSpent}`;

                // Load current repairs
                loadCurrentRepairs(repairs.filter(r => r.status !== 'completed'));
                
                // Load history
                loadHistory(repairs.filter(r => r.status === 'completed'));
            } catch (error) {
                console.error('Error loading repairs:', error);
                showAlert('Error loading repairs', 'error');
            }
        }

        // Load current repairs
        function loadCurrentRepairs(repairs) {
            const container = document.getElementById('currentRepairs');

            if (repairs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No active repairs. Book one to get started!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = repairs.map(repair => `
                <div class="repair-item">
                    <h3>${repair.device_type}${repair.brand ? ' - ' + repair.brand : ''}</h3>
                    ${repair.image_url ? `<img src="${repair.image_url}" class="repair-image" alt="Device photo" onclick="window.open('${repair.image_url}', '_blank')">` : ''}
                    <div class="repair-info">
                        <div class="repair-info-item">
                            <strong>Repair #:</strong> ${repair.repair_number}
                        </div>
                        <div class="repair-info-item">
                            <strong>Issue:</strong> ${repair.issue.substring(0, 50)}${repair.issue.length > 50 ? '...' : ''}
                        </div>
                        <div class="repair-info-item">
                            <strong>Service:</strong> ${repair.service_type}
                        </div>
                        <div class="repair-info-item">
                            <strong>Requested:</strong> ${new Date(repair.date_requested).toLocaleDateString()}
                        </div>
                        <div class="repair-info-item">
                            <strong>Estimate:</strong> ${repair.estimated_cost}
                        </div>
                    </div>
                    ${repair.notes ? `<p style="color: #b0b0b0; margin-top: 10px;"><strong>Tech Notes:</strong> ${repair.notes}</p>` : ''}
                    
                    <div class="status-timeline">
                        <div class="status-step ${['pending', 'received', 'diagnosing', 'repairing', 'ready'].includes(repair.status) ? 'completed' : ''}">
                            <div class="status-dot">‚úì</div>
                            <div class="status-label">Pending</div>
                        </div>
                        <div class="status-step ${['received', 'diagnosing', 'repairing', 'ready'].includes(repair.status) ? 'completed' : repair.status === 'pending' ? 'active' : ''}">
                            <div class="status-dot">${['received', 'diagnosing', 'repairing', 'ready'].includes(repair.status) ? '‚úì' : ''}</div>
                            <div class="status-label">Received</div>
                        </div>
                        <div class="status-step ${['diagnosing', 'repairing', 'ready'].includes(repair.status) ? 'completed' : repair.status === 'received' ? 'active' : ''}">
                            <div class="status-dot">${['diagnosing', 'repairing', 'ready'].includes(repair.status) ? '‚úì' : ''}</div>
                            <div class="status-label">Diagnosing</div>
                        </div>
                        <div class="status-step ${['repairing', 'ready'].includes(repair.status) ? 'completed' : repair.status === 'diagnosing' ? 'active' : ''}">
                            <div class="status-dot">${['repairing', 'ready'].includes(repair.status) ? '‚úì' : ''}</div>
                            <div class="status-label">Repairing</div>
                        </div>
                        <div class="status-step ${repair.status === 'ready' ? 'active' : ''}">
                            <div class="status-dot"></div>
                            <div class="status-label">Ready</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Load messages
        async function loadMessages() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('customer_id', currentUser.id)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                const container = document.getElementById('messagesContainer');
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üí¨</div>
                            <p>No messages yet.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = messages.map(msg => `
                    <div class="message ${msg.from_type === 'tech' ? 'from-tech' : 'from-customer'}">
                        <div class="message-header">
                            <span class="message-sender">${msg.from_type === 'tech' ? 'Glitch Tech' : 'You'}</span>
                            <span class="message-time">${new Date(msg.created_at).toLocaleString()}</span>
                        </div>
                        <div class="message-content">${msg.content}</div>
                    </div>
                `).join('');

                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Send message
        document.getElementById('sendMessage').addEventListener('click', async () => {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message && currentUser) {
                try {
                    const { error } = await supabase
                        .from('messages')
                        .insert([{
                            customer_id: currentUser.id,
                            from_type: 'customer',
                            content: message
                        }]);

                    if (error) throw error;

                    input.value = '';
                    await loadMessages();
                } catch (error) {
                    console.error('Error sending message:', error);
                    showAlert('Error sending message', 'error');
                }
            }
        });

        // Enter key sends message
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendMessage').click();
            }
        });

        // Load history
        function loadHistory(completedRepairs) {
            const container = document.getElementById('repairHistory');

            if (completedRepairs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No repair history yet.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = completedRepairs.map(repair => `
                <div class="repair-item">
                    <h3>${repair.device_type}${repair.brand ? ' - ' + repair.brand : ''}</h3>
                    ${repair.image_url ? `<img src="${repair.image_url}" class="repair-image" alt="Device photo" onclick="window.open('${repair.image_url}', '_blank')">` : ''}
                    <div class="repair-info">
                        <div class="repair-info-item">
                            <strong>Repair #:</strong> ${repair.repair_number}
                        </div>
                        <div class="repair-info-item">
                            <strong>Issue:</strong> ${repair.issue}
                        </div>
                        <div class="repair-info-item">
                            <strong>Service:</strong> ${repair.service_type}
                        </div>
                        <div class="repair-info-item">
                            <strong>Date:</strong> ${new Date(repair.date_requested).toLocaleDateString()}
                        </div>
                        <div class="repair-info-item">
                            <strong>Cost:</strong> ${repair.actual_cost || repair.estimated_cost}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Book repair modal
        document.getElementById('bookRepairBtn').addEventListener('click', () => {
            document.getElementById('bookRepairModal').style.display = 'block';
        });

        function closeBookingModal() {
            document.getElementById('bookRepairModal').style.display = 'none';
            document.getElementById('bookingForm').reset();
            document.getElementById('filePreview').innerHTML = '';
            selectedFile = null;
        }

        // File upload handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const deviceImageInput = document.getElementById('deviceImage');
        const filePreview = document.getElementById('filePreview');

        fileUploadArea.addEventListener('click', () => {
            deviceImageInput.click();
        });

        deviceImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                previewFile(file);
            }
        });

        // Drag and drop
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('drag-over');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('drag-over');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('drag-over');
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedFile = file;
                previewFile(file);
            }
        });

        function previewFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                filePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }

        // Handle booking form
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBookingBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const deviceType = document.getElementById('deviceType').value;
                const brand = document.getElementById('brand').value;
                const issue = document.getElementById('issue').value;
                const serviceType = document.getElementById('serviceType').value;
                const urgency = document.getElementById('urgency').value;

                let imageUrl = null;

                // Upload image if selected
                if (selectedFile) {
                    submitBtn.textContent = 'Uploading image...';
                    const fileExt = selectedFile.name.split('.').pop();
                    const fileName = `${currentUser.id}_${Date.now()}.${fileExt}`;
                    
                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('repair-images')
                        .upload(fileName, selectedFile);

                    if (uploadError) throw uploadError;

                    const { data: { publicUrl } } = supabaseClient.storage
                        .from('repair-images')
                        .getPublicUrl(fileName);

                    imageUrl = publicUrl;
                }

                // Create repair
                submitBtn.textContent = 'Creating repair...';
                const { data: repair, error } = await supabase
                    .from('repairs')
                    .insert([{
                        customer_id: currentUser.id,
                        device_type: deviceType,
                        brand: brand,
                        issue: issue,
                        service_type: serviceType,
                        urgency: urgency,
                        status: 'pending',
                        estimated_cost: getEstimatedCost(serviceType, urgency),
                        image_url: imageUrl
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Send welcome message
                await supabase
                    .from('messages')
                    .insert([{
                        customer_id: currentUser.id,
                        repair_id: repair.id,
                        from_type: 'tech',
                        content: `Thanks for booking! I received your repair request for ${deviceType} (${serviceType}). I'll review it and get back to you shortly!`
                    }]);

                closeBookingModal();
                showAlert('Repair booked successfully! We\'ll be in touch soon.', 'success');
                await loadRepairs();
                await loadMessages();

            } catch (error) {
                console.error('Booking error:', error);
                showAlert('Error booking repair: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Repair Request';
            }
        });

        function getEstimatedCost(serviceType, urgency) {
            let cost = serviceType.match(/\$[\d-]+/)?.[0] || 'TBD';
            if (urgency === 'urgent') {
                cost += ' (+$30 rush)';
            }
            return cost;
        }

        // Close modal on outside click
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('bookRepairModal');
            if (e.target === modal) {
                closeBookingModal();
            }
        });
    </script>

    <!-- Glitch Tech Sound System -->
    <script>
        class GlitchTechSounds {
            constructor() {
                this.audioContext = null;
                this.enabled = true;
                this.volume = 0.3;
                this.initialized = false;
            }

            init() {
                if (this.initialized) return;
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.initialized = true;
                } catch (e) {
                    this.enabled = false;
                }
            }

            playClick() {
                if (!this.enabled) return;
                this.init();
                const ctx = this.audioContext;
                const now = ctx.currentTime;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.05);
                gain.gain.setValueAtTime(this.volume * 0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            }

            playHover() {
                if (!this.enabled) return;
                this.init();
                const ctx = this.audioContext;
                const now = ctx.currentTime;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(500, now + 0.05);
                gain.gain.setValueAtTime(this.volume * 0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            }

            playSuccess() {
                if (!this.enabled) return;
                this.init();
                const ctx = this.audioContext;
                const now = ctx.currentTime;
                [600, 800].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.setValueAtTime(freq, now + i * 0.1);
                    gain.gain.setValueAtTime(this.volume * 0.4, now + i * 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.2);
                    osc.start(now + i * 0.1);
                    osc.stop(now + i * 0.1 + 0.2);
                });
            }

            playError() {
                if (!this.enabled) return;
                this.init();
                const ctx = this.audioContext;
                const now = ctx.currentTime;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(150, now + 0.2);
                gain.gain.setValueAtTime(this.volume * 0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }

            playModalOpen() {
                if (!this.enabled) return;
                this.init();
                const ctx = this.audioContext;
                const now = ctx.currentTime;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.exponentialRampToValueAtTime(800, now + 0.15);
                gain.gain.setValueAtTime(this.volume * 0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            }

            playModalClose() {
                if (!this.enabled) return;
                this.init();
                const ctx = this.audioContext;
                const now = ctx.currentTime;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.15);
                gain.gain.setValueAtTime(this.volume * 0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            }
        }

        const portalSounds = new GlitchTechSounds();

        // Add sounds after DOM is loaded
        window.addEventListener('load', () => {
            // Buttons
            document.querySelectorAll('button, .btn, .send-btn, .logout-btn, .book-repair-btn').forEach(el => {
                el.addEventListener('click', () => portalSounds.playClick());
            });

            // Links
            document.querySelectorAll('a, .back-link, .toggle-auth a').forEach(el => {
                el.addEventListener('mouseenter', () => portalSounds.playHover());
                el.addEventListener('click', () => portalSounds.playClick());
            });

            // Override closeBookingModal to add sound
            const originalCloseBookingModal = window.closeBookingModal;
            window.closeBookingModal = function() {
                portalSounds.playModalClose();
                originalCloseBookingModal();
            };

            // Add sound to modal open
            document.getElementById('bookRepairBtn')?.addEventListener('click', () => {
                portalSounds.playModalOpen();
            });

            // Add sound to successful booking (override form submit)
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                const originalSubmit = bookingForm.onsubmit;
                bookingForm.addEventListener('submit', (e) => {
                    setTimeout(() => portalSounds.playSuccess(), 500);
                });
            }

            // Add sound to login success
            const originalShowDashboard = window.showDashboard;
            if (originalShowDashboard) {
                window.showDashboard = async function() {
                    portalSounds.playSuccess();
                    await originalShowDashboard();
                };
            }

            console.log('üîä Portal Sounds ready!');
        });
    </script>
</body>
</html>
